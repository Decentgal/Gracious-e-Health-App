name: My eHealth DevSecOps Pipeline

on: [push]

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. IAC SCAN (Terraform & Dockerfile Hardening)
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform,dockerfile
          quiet: true
          soft_fail: false # Hard fail if security best practices are missed
          output_format: cli

      # 2. DOCKER CONFIG SCAN (Trivy)
      - name: Scan Dockerfile for Misconfigurations
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: './code-app'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      # 3. BUILD
      - name: Build Docker Image
        run: docker build -t ehealth-app ./code-app

      # 4. SAST (Software Composition Analysis)
      - name: Run Trivy Security Scan (Library/OS)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ehealth-app'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # 5. DAST PREPARATION (Network and Start)
      - name: Start Container for DAST
        run: |
          # Map host port 8080 to container port 5000
          docker run -d -p 8080:5000 --name test-container ehealth-app
          echo "Waiting for Flask app..."
          for i in {1..20}; do
            # Check port 8080 as defined in the mapping above
            if curl -s http://localhost:8080; then
              echo "App is UP!"
              exit 0
            fi
            sleep 3
          done
          docker logs test-container
          exit 1

      # 6. DAST (OWASP ZAP)
      - name: Run OWASP ZAP Attack
        uses: zaproxy/action-baseline@v0.15.0
        with:
          # Use localhost instead of host.docker.internal for GitHub Runners
          target: 'http://localhost:8080' 
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false 
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          cmd_options: '-r report.html -J report.json'

      # 7. ARTIFACT UPLOAD
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            report.*
            results.xml

      - name: Final Status
        if: success()
        run: echo "SAST, DAST, and IaC Scans passed. Infrastructure is fully compliant."